# UTrust Order Payment Change

## 外掛簡介

UTrust Order Payment Change 是一個 WordPress 外掛，專為使用 WooCommerce 的網站設計，能夠自動管理多個金流帳號，根據設定的金額上限自動切換金流服務商。

## 主要功能

### 🚀 自動金流管理
- 支援多個金流帳號管理
- 根據月度金額上限自動切換
- 與 RY WooCommerce Tools 完美整合

### 📊 智能監控
- 即時監控訂單完成狀態
- 自動累計當月交易金額
- 達到上限時自動切換下一個帳號

### 🔄 月度重置
- 每月自動重置累計金額
- 支援手動重置功能
- 完整的備份和歷史記錄

### 📱 友善管理介面
- 直觀的後台管理頁面
- 即時統計資訊顯示
- 完整的操作日誌記錄

## 系統需求

- WordPress 5.0 或以上
- WooCommerce 5.0 或以上
- PHP 7.4 或以上
- MySQL 5.6 或以上

## 相容性說明

### ✅ 完全相容
此外掛**完全支援**以下 WooCommerce 功能：

1. **高效能訂單儲存 (HPOS)**
   - 完全支援 WooCommerce 的新訂單儲存系統
   - 自動偵測並使用適當的訂單處理方式
   - 提供更好的效能和穩定性

2. **電子郵件強化項目**
   - 完全相容 WooCommerce 的電子郵件系統改進功能
   - 不會與訂單監控功能產生衝突
   - 享受更好的電子郵件體驗

### 🚀 技術優勢
- **自動相容性偵測**：外掛會自動偵測 WooCommerce 功能並使用適當的處理方式
- **向後相容**：同時支援傳統訂單系統和新的 HPOS 系統
- **效能優化**：在 HPOS 環境下提供更好的效能表現
- **智能初始化**：自動從現有 RY WooCommerce Tools 設定創建預設金流帳號

### 🔄 自動初始化功能
當外掛首次啟動時，系統會：
1. 檢查是否已安裝 RY WooCommerce Tools
2. 讀取現有的 NewebPay 設定（MerchantID、HashKey、HashIV）
3. 自動創建一個預設金流帳號，金額上限設為 10 萬元
4. 將該帳號設為啟用狀態
5. 在管理介面顯示創建通知

### 📝 版本更新
- **v1.2.0**: 加入自動創建預設金流帳號功能
- **v1.1.0**: 加入 HPOS 和電子郵件強化項目支援
- **v1.0.1**: 加入相容性檢查和警告系統
- **v1.0.0**: 初始版本

## 安裝方法

### 方法一：上傳安裝
1. 下載外掛檔案
2. 在 WordPress 後台上傳並啟用外掛
3. 前往「金流管理」頁面進行設定

### 方法二：FTP 安裝
1. 將外掛資料夾上傳到 `/wp-content/plugins/` 目錄
2. 在 WordPress 後台啟用外掛
3. 前往「金流管理」頁面進行設定

## 使用說明

### 1. 新增金流帳號
1. 前往「金流管理」頁面
2. 點擊「新增金流帳號」按鈕
3. 填寫帳號資訊：
   - 帳號名稱（自訂名稱）
   - MerchantID
   - HashKey
   - HashIV
   - 金額上限
4. 選擇是否設為啟用狀態
5. 點擊「儲存」

### 2. 管理金流帳號
- **編輯帳號**：點擊帳號列表中的「編輯」按鈕
- **啟用帳號**：點擊「啟用」按鈕切換到該帳號
- **刪除帳號**：點擊「刪除」按鈕移除帳號（僅限非啟用狀態）

### 3. 監控和統計
- 查看目前使用中的金流帳號
- 監控當月累計金額
- 查看剩餘可用額度
- 瀏覽切換歷史記錄

### 4. 月度重置
- 系統會在每月 1 日凌晨 2 點自動執行重置
- 可手動點擊「重置當月金額」按鈕執行重置
- 重置後會自動切換到第一個可用的金流帳號

## 功能模組說明

### 模組一：初始化模組
- 外掛啟用時自動建立資料表
- 設定預設選項和配置
- 支援資料保留機制

### 模組二：管理頁面模組
- 完整的後台管理介面
- 金流帳號的增刪改查
- 即時狀態顯示和操作

### 模組三：訂單監控模組
- 監控 WooCommerce 訂單狀態
- 自動累計交易金額
- 支援退款處理

### 模組四：金流切換模組
- 智能判斷切換時機
- 自動更新 RY WooCommerce Tools 設定
- 完整的切換記錄

### 模組五：月度重置模組
- WP-Cron 自動執行
- 資料備份和歷史記錄
- 手動重置支援

## 設定選項

### 基本設定
- `utopc_keep_data_on_deactivate`：停用外掛時是否保留資料
- `utopc_auto_switch_enabled`：是否啟用自動切換功能
- `utopc_enable_logging`：是否啟用日誌記錄
- `utopc_enable_notifications`：是否啟用郵件通知

### 進階設定
- `utopc_allow_manual_reset`：是否允許手動重置
- 日誌保留數量限制
- 備份資料保留期限

## 資料庫結構

外掛會建立以下資料表：
- `wp_utopc_payment_accounts`：金流帳號資料表

主要欄位：
- `id`：唯一識別碼
- `account_name`：帳號名稱
- `merchant_id`：MerchantID
- `hash_key`：HashKey
- `hash_iv`：HashIV
- `amount_limit`：金額上限
- `monthly_amount`：當月累計金額
- `is_active`：是否啟用
- `created_at`：建立時間
- `updated_at`：更新時間

## 安全考量

- 所有使用者輸入都經過安全處理
- 使用 WordPress nonce 防止 CSRF 攻擊
- 權限檢查確保只有管理員可操作
- 敏感資訊（如 HashKey）在顯示時會進行隱碼處理

## 故障排除

### 常見問題

**Q: 外掛啟用後沒有看到「金流管理」選單？**
A: 請確認您具有管理員權限，且 WooCommerce 已正確啟用。

**Q: 自動切換功能不工作？**
A: 請檢查是否啟用了自動切換功能，並確認有可用的備用帳號。

**Q: 月度重置沒有執行？**
A: 請檢查 WordPress 的 WP-Cron 功能是否正常運作。

**Q: 無法更新 RY WooCommerce Tools 設定？**
A: 請確認 RY WooCommerce Tools 外掛已啟用，且具有適當的權限。

### 日誌查看
- 前往「金流管理」頁面
- 點擊「查看日誌」按鈕
- 檢查錯誤和警告訊息

### 手動重置
如果自動重置失敗，可以：
1. 手動點擊「重置當月金額」按鈕
2. 檢查系統日誌了解錯誤原因
3. 聯絡技術支援

## 更新日誌

### 版本 1.0.0
- 初始版本發布
- 完整的金流帳號管理功能
- 自動切換和月度重置功能
- 友善的管理介面

## 技術支援

如果您遇到問題或需要技術支援，請：
1. 檢查外掛日誌
2. 確認系統需求
3. 聯絡技術支援團隊

## 授權條款

本外掛採用 GPL v2 或更新版本授權。

## 免責聲明

本外掛僅供教育目的使用，使用者需自行承擔使用風險。開發者不保證外掛的適用性或無錯誤性。
